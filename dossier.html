<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORDO CONTINUUM // SANCTUS RECORD</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    
    <script type="module" src="database.js"></script>
    
    <style>
        :root {
            --bg-color: #0f0b0b; --panel-bg: #141010; --text-main: #e0d8c0; --text-gold: #d4af37;
            --text-gold-dim: #8a7338; --accent-crimson: #660000; --accent-bright-red: #8a0000;
            --border-gold: #9d8033; --input-bg: rgba(0, 0, 0, 0.4);
            --font-headers: 'Cinzel', serif; --font-body: 'Cormorant Garamond', serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; scrollbar-width: thin; scrollbar-color: var(--text-gold-dim) var(--bg-color); }
        input[type="number"], input[type="text"], textarea, select { background: var(--input-bg); border: 1px solid var(--text-gold-dim); color: var(--text-gold); font-family: var(--font-headers); padding: 5px; text-align: center; transition: all 0.3s; }
        input[type="number"], input[type="text"] { width: 60px; }
        select { width: auto; text-align: left; cursor: pointer; }
        select option { background: var(--bg-color); color: var(--text-gold); }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--text-gold); box-shadow: 0 0 10px rgba(212, 175, 55, 0.2); }
        .imperial-input { background: transparent !important; border: none !important; border-bottom: 1px dashed var(--text-gold-dim) !important; color: var(--text-main) !important; font-family: var(--font-headers) !important; font-weight: 700 !important; font-size: 1rem !important; width: 100% !important; padding: 2px 5px !important; text-align: right !important; }
        .imperial-input:focus { border-bottom: 1px solid var(--text-gold) !important; background: rgba(212, 175, 55, 0.05) !important; }
        .imperial-textarea { background: rgba(0, 0, 0, 0.2) !important; border: 1px solid var(--text-gold-dim) !important; color: var(--text-main) !important; font-family: var(--font-body) !important; font-size: 1.1rem !important; width: 100% !important; padding: 10px !important; resize: vertical !important; min-height: 80px !important; text-align: left !important; }
        .imperial-textarea:focus { border-color: var(--text-gold) !important; }
        body { background-color: var(--bg-color); background-image: radial-gradient(circle at center, rgba(102, 0, 0, 0.05) 0%, transparent 70%), url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4af37' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); color: var(--text-main); font-family: var(--font-body); height: 100vh; overflow: hidden; display: flex; flex-direction: column; font-size: 18px; border: 4px double var(--border-gold); margin: 0; }
        body::after { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; box-shadow: inset 0 0 150px rgba(0,0,0,0.9); pointer-events: none; z-index: 50; }
        header { height: 80px; border-bottom: 2px solid var(--text-gold); display: flex; justify-content: space-between; align-items: center; padding: 0 40px; background: linear-gradient(to bottom, #1a0f0f, #0f0b0b); position: relative; z-index: 60; box-shadow: 0 5px 20px rgba(0,0,0,0.8); }
        header::after { content: ''; position: absolute; bottom: -5px; left: 0; right: 0; height: 3px; background: var(--accent-crimson); border-bottom: 1px solid #000; }
        .back-btn { border: 1px solid var(--text-gold); background: transparent; color: var(--text-gold); padding: 5px 15px; font-family: var(--font-headers); font-size: 1rem; cursor: pointer; margin-right: 25px; transition: all 0.3s; text-transform: uppercase; text-decoration: none; display: flex; align-items: center; height: 40px; }
        .back-btn:hover { background: var(--text-gold); color: #000; box-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
        .brand-title { font-family: var(--font-headers); font-size: 1.8rem; color: var(--text-gold); text-shadow: 0 2px 4px rgba(0,0,0,0.5); letter-spacing: 2px; font-weight: 700; display: flex; align-items: center; gap: 15px; }
        .symbol-triangle { font-size: 2.5rem; background: linear-gradient(180deg, var(--text-gold) 0%, var(--accent-crimson) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block; transform: scaleY(0.8); }
        .brand-subtitle { font-size: 0.8rem; color: var(--accent-crimson); text-transform: uppercase; letter-spacing: 4px; margin-top: 5px; }
        .system-time { font-family: var(--font-headers); color: var(--text-gold-dim); font-size: 1rem; border: 1px solid var(--text-gold-dim); padding: 5px 15px; background: rgba(0,0,0,0.3); }
        .main-container { display: flex; flex: 1; overflow: hidden; position: relative; z-index: 55; }
        aside { width: 300px; background: rgba(15, 11, 11, 0.95); border-right: 1px solid var(--text-gold-dim); display: flex; flex-direction: column; padding: 40px 0; position: relative; }
        .nav-group { display: flex; align-items: center; padding-right: 15px; transition: background 0.3s; }
        .nav-group:hover { background: rgba(212, 175, 55, 0.05); }
        .nav-btn { background: transparent; border: none; color: var(--text-gold-dim); padding: 20px 20px; text-align: left; font-family: var(--font-headers); text-transform: uppercase; font-size: 1rem; letter-spacing: 1px; cursor: pointer; transition: all 0.4s ease; flex-grow: 1; }
        .nav-btn:hover { color: var(--text-main); text-shadow: 0 0 8px rgba(212, 175, 55, 0.4); }
        .nav-btn.active { color: var(--text-gold); background: linear-gradient(90deg, transparent 0%, rgba(212, 175, 55, 0.1) 50%, transparent 100%); border-left: 2px solid var(--text-gold); }
        
        .lock-toggle { appearance: none; -webkit-appearance: none; width: 20px; height: 20px; border: 2px solid var(--text-gold-dim); background: rgba(0,0,0,0.5); cursor: pointer; margin-left: 10px; transition: all 0.3s; position: relative; }
        .lock-toggle:checked { background: var(--accent-bright-red); border-color: var(--accent-bright-red); box-shadow: 0 0 10px var(--accent-bright-red); }

        main { flex: 1; padding: 50px 80px; overflow-y: auto; position: relative; }
        .content-panel { display: none; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .content-panel.active { display: block; }
        h1 { font-family: var(--font-headers); font-size: 2.5rem; color: var(--text-gold); text-align: center; margin-bottom: 40px; border-bottom: 1px solid var(--text-gold-dim); padding-bottom: 15px; position: relative; }
        h2 { font-family: var(--font-headers); color: var(--text-main); font-size: 1.2rem; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 2px; border-bottom: 2px solid var(--accent-crimson); display: inline-block; padding-right: 20px; }
        .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; margin-bottom: 40px; }
        .data-block { background: rgba(20, 16, 16, 0.6); border: 1px solid var(--text-gold-dim); padding: 25px; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.3); transition: transform 0.3s; }
        .data-block:hover { transform: translateY(-2px); box-shadow: 0 5px 25px rgba(212, 175, 55, 0.1); border-color: var(--text-gold); }
        .stat-row { display: flex; justify-content: space-between; align-items: baseline; padding: 8px 0; border-bottom: 1px solid rgba(212, 175, 55, 0.2); }
        .stat-label { color: var(--text-gold-dim); font-style: italic; font-size: 1.1rem; white-space: nowrap; margin-right: 15px; }
        .stat-value { color: var(--text-main); font-family: var(--font-headers); font-weight: 700; }
        .warning-text { color: var(--accent-bright-red); text-shadow: 0 0 5px rgba(138, 0, 0, 0.5); }
        .attribute-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; margin-bottom: 40px; border: 1px solid var(--text-gold-dim); padding: 20px; background: rgba(0,0,0,0.2); position: relative; }
        .stat-box { text-align: center; border: 1px solid rgba(212, 175, 55, 0.1); padding: 15px 5px; transition: background 0.3s; }
        .stat-box:hover { background: rgba(212, 175, 55, 0.05); border-color: var(--text-gold); }
        .stat-box h2 { font-size: 1rem; border: none; margin: 0; color: var(--text-gold-dim); }
        .stat-box .big-val { font-family: var(--font-headers); font-size: 2.2rem; color: var(--text-main); display: block; margin: 5px 0; }
        .stat-box .mod-val { color: var(--accent-crimson); font-weight: bold; }
        ul.wax-list { list-style: none; padding-left: 10px; }
        ul.wax-list li { position: relative; padding-left: 25px; margin-bottom: 10px; border-left: 2px solid var(--accent-crimson); transition: padding-left 0.3s; display: flex; justify-content: space-between; align-items: center; padding-right: 10px; }
        ul.wax-list li:hover { padding-left: 35px; background: linear-gradient(90deg, rgba(138, 0, 0, 0.1), transparent); }
        ul.wax-list li::before { content: ""; position: absolute; left: -6px; top: 50%; transform: translateY(-50%); width: 10px; height: 10px; background: var(--accent-crimson); border-radius: 50%; }
        .interactive-list-item { cursor: pointer; }
        .interactive-list-item:hover { color: var(--text-gold); text-shadow: 0 0 5px var(--text-gold); }
        .sub-nav { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; border-bottom: 1px solid var(--text-gold-dim); padding-bottom: 10px; flex-wrap: wrap; }
        .sub-nav-btn { background: none; border: 1px solid transparent; color: var(--text-gold-dim); font-family: var(--font-headers); font-size: 1rem; padding: 8px 16px; cursor: pointer; text-transform: uppercase; transition: all 0.3s; }
        .sub-nav-btn.active { color: var(--text-gold); border: 1px solid var(--text-gold); background: rgba(212, 175, 55, 0.1); }
        .sub-panel { display: none; animation: fadeIn 0.5s; }
        .sub-panel.active { display: block; }
        .imperial-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; border: 1px solid var(--text-gold-dim); }
        .imperial-table th, .imperial-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid rgba(212, 175, 55, 0.2); }
        .imperial-table th { background: rgba(212, 175, 55, 0.1); color: var(--text-gold); }
        .imperial-table .proficient { color: var(--text-gold); }
        .imperial-table .expertise { color: var(--accent-bright-red); font-weight: bold; }
        .weapon-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--text-gold-dim); cursor: pointer; transition: background 0.3s; }
        .weapon-row:hover { background: rgba(212, 175, 55, 0.1); }
        .add-btn { background: none; border: 1px solid var(--text-gold-dim); color: var(--text-gold); font-size: 0.8rem; padding: 2px 8px; cursor: pointer; margin-left: 10px; transition: all 0.2s; }
        .add-btn:hover { background: var(--text-gold); color: var(--bg-color); }
        .del-btn { background: transparent; border: none; color: var(--text-gold-dim); font-weight: bold; cursor: pointer; padding: 0 5px; font-family: var(--font-headers); transition: color 0.2s; margin-left: 10px; }
        .del-btn:hover { color: var(--accent-bright-red); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-color); border: 2px solid var(--text-gold); width: 600px; padding: 40px; position: relative; box-shadow: 0 0 50px rgba(0,0,0,1); }
        .close-modal { position: absolute; top: 10px; right: 15px; color: var(--accent-bright-red); font-size: 2rem; cursor: pointer; }
        #modal-title-input { width: 100%; font-size: 2rem; margin-bottom: 20px; background: transparent; border: none; border-bottom: 2px solid var(--text-gold); color: var(--text-gold); font-family: var(--font-headers); text-align: center; }
        .prof-checkbox, .chk-prof { appearance: none; -webkit-appearance: none; width: 18px; height: 18px; border: 2px solid var(--text-gold-dim); background: rgba(0,0,0,0.5); cursor: pointer; display: inline-block; vertical-align: middle; transition: all 0.3s; }
        .prof-checkbox:checked, .chk-prof:checked { background: var(--text-gold); border-color: var(--text-gold); box-shadow: 0 0 8px rgba(212, 175, 55, 0.6); }
        .exp-checkbox, .chk-exp { appearance: none; -webkit-appearance: none; width: 18px; height: 18px; border: 2px solid var(--accent-crimson); background: rgba(0,0,0,0.5); cursor: pointer; display: inline-block; vertical-align: middle; transition: all 0.3s; }
        .exp-checkbox:checked, .chk-exp:checked { background: var(--accent-crimson); border-color: var(--accent-crimson); box-shadow: 0 0 8px rgba(138, 0, 0, 0.8); }
        .char-img-container { border: 2px solid var(--text-gold-dim); padding: 5px; position: relative; background: rgba(0,0,0,0.3); box-shadow: inset 0 0 20px rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; min-height: 400px; }
        .spell-name-btn { background: transparent; border: 1px solid var(--text-gold-dim); color: var(--text-main); padding: 5px 10px; font-family: var(--font-headers); cursor: pointer; width: 100%; text-align: left; transition: all 0.3s; }
        .spell-name-btn:hover { background: rgba(212, 175, 55, 0.1); border-color: var(--text-gold); }
        .table-section-header { background: rgba(102, 0, 0, 0.2); color: var(--accent-crimson); font-weight: bold; text-align: center; padding: 10px; letter-spacing: 2px; border-bottom: 2px solid var(--accent-crimson); }
        .access-denied-screen { display: none; flex-direction: column; justify-content: center; align-items: center; height: 100%; width: 100%; text-align: center; color: var(--accent-bright-red); animation: pulseRed 2s infinite; }
        .access-denied-screen h1 { font-size: 4rem; border: none; text-shadow: 0 0 20px var(--accent-bright-red); }
        .access-denied-screen p { font-family: var(--font-headers); font-size: 1.5rem; letter-spacing: 5px; }
        @keyframes pulseRed { 0% { opacity: 0.8; } 50% { opacity: 1; text-shadow: 0 0 30px var(--accent-bright-red); } 100% { opacity: 0.8; } }
        .empty-data-msg { color: var(--text-gold-dim); text-align: center; padding: 20px; border: 1px dashed var(--text-gold-dim); margin-top: 10px; font-style: italic; display: none; }
        footer { border-top: 1px solid var(--text-gold-dim); padding: 10px 40px; font-family: var(--font-headers); font-size: 0.8rem; color: var(--text-gold-dim); text-align: center; letter-spacing: 5px; background: #0f0b0b; z-index: 60; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .total-mod { font-weight: 900; color: var(--accent-bright-red); font-size: 1.2rem; text-shadow: 0 0 5px rgba(138, 0, 0, 0.5); }
        @media (max-width: 900px) { .main-container { flex-direction: column; } aside { width: 100%; border-right: none; border-bottom: 2px solid var(--text-gold); padding: 20px; flex-direction: row; overflow-x: auto; } main { padding: 20px; } .stats-wrapper { grid-template-columns: 1fr; } .attribute-grid { grid-template-columns: repeat(3, 1fr); } .modal-content { width: 95%; margin: 10px; } .imperial-table input[type="text"] { width: 80px; } }
    </style>
</head>
<body>

<header>
    <div style="display: flex; align-items: center;">
        <button class="back-btn" onclick="window.location.href='index.html'">← РЕЕСТР</button>
        <div class="brand">
            <div class="brand-title">
                <span class="symbol-triangle">▼</span>
                <div>ORDO CONTINUUM<div class="brand-subtitle">Ex Tenebris Lux</div></div>
            </div>
        </div>
    </div>
    <div class="system-time" id="clock">00:00:00 ULT</div>
</header>

<div class="main-container">
    <aside>
        <div class="nav-group"><button class="nav-btn active" onclick="showPanel('identity')">I. Identitas</button><input type="checkbox" class="lock-toggle" onchange="toggleLock('identity', this)"></div>
        <div class="nav-group"><button class="nav-btn" onclick="showPanel('biometrics')">II. Corpus</button><input type="checkbox" class="lock-toggle" onchange="toggleLock('biometrics', this)"></div>
        <div class="nav-group"><button class="nav-btn" onclick="showPanel('skills')">III. Artes</button><input type="checkbox" class="lock-toggle" onchange="toggleLock('skills', this)"></div>
        <div class="nav-group"><button class="nav-btn" onclick="showPanel('equipment')">IV. Armamentum</button><input type="checkbox" class="lock-toggle" onchange="toggleLock('equipment', this)"></div>
        <div class="nav-group"><button class="nav-btn" onclick="showPanel('psych')">V. Anima</button><input type="checkbox" class="lock-toggle" onchange="toggleLock('psych', this)"></div>
        <div class="nav-group"><button class="nav-btn" onclick="showPanel('psionics')">VI. Psionica</button><input type="checkbox" class="lock-toggle" onchange="toggleLock('psionics', this)"></div>
        <div class="nav-group"><button class="nav-btn" onclick="showPanel('universalis')">VII. Universalis</button><input type="checkbox" class="lock-toggle" onchange="toggleLock('universalis', this)"></div>
    </aside>

    <main>
        <div id="access-denied" class="access-denied-screen"><h1>⛔</h1><h1>ДОСТУП ЗАКРЫТ</h1><p>UNAUTHORIZED ACCESS ATTEMPT LOGGED</p><p style="font-size: 0.8rem; margin-top: 20px;">Ordo Continuum Security Protocol</p></div>

        <!-- IDENTITY -->
        <div id="identity" class="content-panel active">
            <h1>Sanctus Dossier</h1>
            <div class="data-grid">
                <div class="data-block" style="grid-row: span 2;">
                    <h2>Imago / Облик</h2>
                    <div class="char-img-container">
                        <img id="char-img" src="" style="max-width: 100%; max-height: 400px; display: block;">
                        <input type="file" id="img-upload" style="display:none" accept="image/*" onchange="handleImageUpload(this)">
                        <button class="add-btn" style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); border: 1px solid var(--text-gold);" onclick="triggerImageUpload()">[↻]</button>
                    </div>
                </div>
                <div class="data-block">
                    <h2>Registrum Primus</h2>
                    <div class="stat-row"><span class="stat-label">Имя нареченное:</span> <input type="text" class="imperial-input" id="meta-name"></div>
                    <div class="stat-row"><span class="stat-label">Происхождение:</span> <input type="text" class="imperial-input" id="meta-race"></div>
                    <div class="stat-row"><span class="stat-label">Летоисчисление:</span> <input type="text" class="imperial-input" id="meta-age"></div>
                    <div class="stat-row"><span class="stat-label">Ранг:</span> <input type="text" class="imperial-input" id="meta-rank"></div>
                    <div class="stat-row"><span class="stat-label">Призвание:</span> <input type="text" class="imperial-input" id="meta-class"></div>
                    <div class="stat-row"><span class="stat-label">Доктрина:</span> <input type="text" class="imperial-input" id="meta-archetype"></div>
                    <div style="margin-top: 20px; border-top: 1px solid var(--text-gold-dim); padding-top: 10px;">
                        <div class="stat-row"><span class="stat-label" style="color: var(--text-gold);">Уровень Доступа:</span><input type="number" id="level-input" min="1" max="20" onchange="recalc()"></div>
                        <div class="stat-row"><span class="stat-label">Бонус Мастерства:</span><span class="stat-value" id="pb-display" style="color: var(--accent-bright-red);">+2</span></div>
                    </div>
                </div>
                <div class="data-block" style="border-color: var(--accent-crimson); background: linear-gradient(rgba(102, 0, 0, 0.1), transparent);">
                    <h2 style="color: var(--accent-crimson);">Nota Bene</h2>
                    <ul class="wax-list">
                        <li><span>Должность:</span> <input type="text" class="imperial-input" id="meta-job" style="width: 50% !important; text-align: left !important;"></li>
                        <li><span>Допуск:</span> <input type="text" class="imperial-input" id="meta-clearance" style="width: 50% !important; text-align: left !important;"></li>
                        <li><span>Связь:</span> <input type="text" class="imperial-input" id="meta-comm" style="width: 50% !important; text-align: left !important;"></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- BIOMETRICS -->
        <div id="biometrics" class="content-panel">
            <h1>Parametri Corporis</h1>
            <div class="data-block" style="margin-bottom: 20px;">
                <h2>Vitalis Status</h2>
                <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
                    <div style="text-align: center;"><div class="stat-label">Хиты (Текущ / Макс)</div><div style="display: flex; align-items: center; gap: 5px; justify-content: center;"><input type="number" id="hp-curr" class="warning-text" style="width: 80px;"> / <input type="number" id="hp-max" style="width: 80px;"></div></div>
                    <div style="text-align: center;"><div class="stat-label">Класс Брони (AC)</div><input type="number" id="ac-val" style="font-size: 1.5rem; color: var(--text-main);"></div>
                    <div style="text-align: center;"><div class="stat-label">Мобильность (Мод | Итого)</div><div style="display: flex; align-items: center; gap: 10px;"><input type="number" id="speed-mod" onchange="updateSpeed()"><span id="speed-display" class="stat-value">9 м</span></div></div>
                </div>
            </div>
            <div class="stats-wrapper">
                <div><h2>Характеристики</h2><div class="attribute-grid" id="attribute-grid"></div></div>
                <div class="data-block"><h2>Спасброски (Авто)</h2><table class="imperial-table"><tbody id="saves-table"></tbody></table></div>
            </div>
        </div>

        <!-- SKILLS -->
        <div id="skills" class="content-panel">
            <h1>Matrix Competentia</h1>
            <div class="sub-nav"><button class="sub-nav-btn active" onclick="showSubPanel('tab-skills')">I. Навыки</button><button class="sub-nav-btn" onclick="showSubPanel('tab-abilities')">II. Умения</button><button class="sub-nav-btn" onclick="showSubPanel('tab-traits')">III. Черты</button><button class="sub-nav-btn" onclick="showSubPanel('tab-features')">IV. Особенности</button><button class="sub-nav-btn" onclick="showSubPanel('tab-profs')">V. Владение</button></div>
            <div id="tab-skills" class="sub-panel active"><div class="data-block" style="width: 100%;"><h2>Общий Реестр Навыков</h2><table class="imperial-table"><thead><tr><th>Название</th><th>Атр.</th><th>Вл.</th><th>Комп.</th><th>Бонус</th><th>Итог</th></tr></thead><tbody id="skills-body"></tbody></table></div></div>
            <div id="tab-abilities" class="sub-panel"><div class="data-block"><h2>Боевые Умения <button class="add-btn" onclick="addItemToGlobal('abilities')">[+]</button></h2><ul class="wax-list" id="list-abilities"></ul></div></div>
            <div id="tab-traits" class="sub-panel"><div class="data-block"><h2>Личностные Черты <button class="add-btn" onclick="addItemToGlobal('traits')">[+]</button></h2><table class="imperial-table"><tbody id="list-traits"></tbody></table></div></div>
            <div id="tab-features" class="sub-panel"><div class="data-block"><h2>Особенности <button class="add-btn" onclick="addItemToGlobal('features')">[+]</button></h2><table class="imperial-table"><tbody id="list-features"></tbody></table></div></div>
            <div id="tab-profs" class="sub-panel"><div class="data-grid"><div class="data-block"><h2>Языки <button class="add-btn" onclick="addSimpleItem('langs')">[+]</button></h2><ul class="wax-list" id="list-langs"></ul></div><div class="data-block"><h2>Инструменты <button class="add-btn" onclick="addSimpleItem('tools')">[+]</button></h2><ul class="wax-list" id="list-tools"></ul></div></div></div>
        </div>

        <!-- EQUIPMENT -->
        <div id="equipment" class="content-panel">
            <h1>Armamentum Sacrum</h1>
            <div class="data-grid">
                <div class="data-block"><h2>Оружие Возмездия <button class="add-btn" onclick="addItemToGlobal('weapons')">[+]</button></h2><div id="list-weapons"></div></div>
                <div class="data-block"><h2>Инвентарь <button class="add-btn" onclick="addItemToGlobal('inventory')">[+]</button></h2><div id="list-inventory"></div></div>
                <div class="data-block"><h2>Финансовые Активы</h2><table class="imperial-table"><tr><td>Юниты (U)</td><td><input type="number" id="money-u" onchange="calcCurrency()"></td></tr><tr><td>К-Юниты (kG)</td><td><input type="number" id="money-k" onchange="calcCurrency()"></td></tr><tr><td>М-Юниты (MG)</td><td><input type="number" id="money-m" onchange="calcCurrency()"></td></tr><tr><td>Г-Юниты (GG)</td><td><input type="number" id="money-g" onchange="calcCurrency()"></td></tr></table><div class="stat-box" style="margin-top: 10px; border-color: var(--text-gold);"><h2>Конвертация (kG)</h2><span class="big-val" id="total-kg" style="color: var(--text-gold);">0.00 kG</span></div></div>
            </div>
        </div>

        <!-- PSYCH -->
        <div id="psych" class="content-panel">
            <h1>Profilus Anima</h1>
            <div class="data-grid">
                <div class="data-block"><h2>Антропометрия</h2><div class="stat-row"><span class="stat-label">Размер:</span> <input type="text" class="imperial-input" id="psych-size"></div><div class="stat-row"><span class="stat-label">Возраст:</span> <input type="text" class="imperial-input" id="psych-age"></div><div class="stat-row"><span class="stat-label">Рост:</span> <input type="text" class="imperial-input" id="psych-height"></div><div class="stat-row"><span class="stat-label">Вес:</span> <input type="text" class="imperial-input" id="psych-weight"></div></div>
                <div class="data-block"><h2>Характеристика Личности</h2><div style="margin-bottom: 10px;"><span class="stat-label">Черта:</span><textarea class="imperial-textarea" id="psych-trait"></textarea></div><div style="margin-bottom: 10px;"><span class="stat-label">Идеал:</span><textarea class="imperial-textarea" id="psych-ideal"></textarea></div><div style="margin-bottom: 10px;"><span class="stat-label">Привязанность:</span><textarea class="imperial-textarea" id="psych-bond"></textarea></div><div><span class="stat-label">Слабость:</span><textarea class="imperial-textarea" id="psych-flaw"></textarea></div></div>
                <div class="data-block" style="border-color: var(--accent-bright-red);"><h2 style="color: var(--accent-bright-red);">Анализ Психики</h2><textarea class="imperial-textarea" style="height: 150px; border-color: var(--accent-crimson);" id="psych-analysis"></textarea></div>
            </div>
        </div>

        <!-- PSIONICS -->
        <div id="psionics" class="content-panel">
            <h1>Psionica & Mysterium</h1>
            <div class="sub-nav"><button class="sub-nav-btn active" onclick="showSubPanel('tab-psi-chars')">I. Характеристики</button><button class="sub-nav-btn" onclick="showSubPanel('tab-psi-spells')">II. Заклинания</button></div>
            <div id="tab-psi-chars" class="sub-panel active">
                <div class="data-grid">
                    <div class="data-block"><h2>Базовые параметры</h2><div class="stat-row"><span class="stat-label">Базовая хар-ка:</span><select id="psi-base-attr" onchange="updatePsi()"><option value="int">INT</option><option value="wis">WIS</option><option value="cha">CHA</option></select></div><div class="stat-row"><span class="stat-label">Тип кастера:</span><select id="psi-caster-type" onchange="updatePsi()"><option value="1">Полный (x1)</option><option value="0.5">Половинный (1/2)</option><option value="0.33">Третичный (1/3)</option></select></div><div class="stat-row"><span class="stat-label">Класс Псионики:</span><input type="number" id="psi-class-lvl" onchange="updatePsi()"></div><div class="stat-row"><span class="stat-label">Тип Псионики:</span><select id="psi-type-select" onchange="updatePsi()"><option value="learned">Учёная</option><option value="intuitive">Интуитивная</option></select></div><div class="stat-row"><span class="stat-label">Мод. Пси-Очков:</span><input type="number" id="psi-mod-input" onchange="updatePsi()"></div></div>
                    <div class="data-block"><h2>Вывод</h2><div class="stat-row"><span class="stat-label">Сложность спасброска:</span> <span class="stat-value warning-text" id="psi-dc-display">12</span></div><div class="stat-row"><span class="stat-label">Пси-Очки:</span> <div style="display: inline-flex; align-items: center; gap: 5px;"><input type="number" id="psi-points-curr" class="warning-text" style="width: 50px;"> / <span class="stat-value warning-text" id="psi-points-max">12</span></div></div></div>
                </div>
            </div>
            <div id="tab-psi-spells" class="sub-panel"><div class="data-block" style="width: 100%;"><h2>Матрица Заклинаний <button class="add-btn" onclick="addItemToGlobal('spells')">[+]</button></h2><table class="imperial-table"><thead><tr><th style="width: 20%;">Название</th><th>Время</th><th>Дистанция</th><th>Конц.</th><th>Длительность</th><th>Стоимость</th><th></th></tr></thead><tbody id="list-spells"></tbody></table></div></div>
        </div>

        <!-- UNIVERSALIS -->
        <div id="universalis" class="content-panel">
            <h1>Universalis: Moduli Additivi</h1>
            <div class="data-grid">
                <div class="data-block"><h2>Калькулятор Спасброска</h2><div class="stat-row"><span class="stat-label">Базовое число:</span><input type="number" id="uni-save-base" onchange="calcUniversalSave()"></div><div class="stat-row"><span class="stat-label">Характеристика:</span><select id="uni-save-attr" onchange="calcUniversalSave()"><option value="str">STR</option><option value="dex">DEX</option><option value="con">CON</option><option value="int">INT</option><option value="wis">WIS</option><option value="cha">CHA</option></select></div><div class="stat-box" style="margin-top: 15px;"><h3>Итог</h3><span class="big-val warning-text" id="uni-save-result">15</span></div></div>
                <div class="data-block"><h2>Пользовательский Реестр <button class="add-btn" onclick="addItemToGlobal('custom')">[+]</button></h2><div id="list-custom"></div></div>
                <div class="data-block"><h2>Счетчики и Ресурсы <button class="add-btn" onclick="addCounter()">[+]</button></h2><div id="list-counters"></div></div>
            </div>
        </div>
    </main>
</div>

<!-- MODAL -->
<div id="weapon-modal" class="modal-overlay">
    <div class="modal-content"><span class="close-modal" onclick="closeWeaponModal()">&times;</span><input type="text" id="modal-title-input" value="Weapon Name"><textarea id="modal-desc" rows="10" style="width: 100%; text-align: left; padding: 10px; font-family: var(--font-body); font-size: 1.1rem; color: var(--text-main); background: rgba(0,0,0,0.5);">Description...</textarea><div style="text-align: right; margin-top: 10px; color: var(--text-gold-dim); font-size: 0.8rem;">* Данные сохраняются автоматически при закрытии</div></div>
</div>

<footer>GLORIA IN EXCELSIS ORDO CONTINUUM // VERITAS LUX MEA</footer>

<script type="module">
    // Ждем инициализации из database.js
    const waitForDB = () => { if (window.OrdoDB) { initDossier(); } else { setTimeout(waitForDB, 100); } };
    waitForDB();

    let activeCharData = null;
    let activeCharId = null;
    let saveTimeout = null;
    let activeModalItem = null;
    const lockStates = { identity: false, biometrics: false, skills: false, equipment: false, psych: false, psionics: false, universalis: false };

    async function initDossier() {
        await OrdoDB.init();
        
        const params = new URLSearchParams(window.location.search);
        activeCharId = params.get('id');

        if(activeCharId) {
            // Подписываемся на обновления в реальном времени
            OrdoDB.subscribeOne(activeCharId, (data) => {
                if (data) {
                    activeCharData = data;
                    // Инициализируем структуру только первый раз или полностью перерисовываем
                    // Здесь для простоты перерисовываем всё, но сохраняем фокус если надо (пропускаем пока)
                    renderAll();
                } else {
                    alert("Персонаж не найден или удален.");
                    window.location.href = "index.html";
                }
            });
            
            initSkeleton();
            startClock();
            setupAutoSave();
        } else {
            alert("Не указан ID.");
            window.location.href = "index.html";
        }
    }

    function startClock() { setInterval(() => document.getElementById('clock').textContent = new Date().toISOString().split('T')[1].split('.')[0] + " ULT", 1000); }

    function setupAutoSave() {
        document.body.addEventListener('input', (e) => {
            if(e.target.closest('.modal-content')) return; 
            handleInputUpdate(e.target);
            triggerSave();
        });
        document.body.addEventListener('change', (e) => {
            handleInputUpdate(e.target);
            triggerSave();
        });
    }

    function triggerSave() {
        if(saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => { OrdoDB.set(activeCharId, activeCharData); }, 500);
    }

    function handleInputUpdate(el) {
        if(!activeCharData) return;
        const id = el.id;
        if(id.startsWith('meta-')) activeCharData.meta[id.replace('meta-', '')] = el.value;
        if(id === 'level-input') { activeCharData.meta.level = parseInt(el.value) || 1; recalc(); }
        if(id.startsWith('attr-')) { activeCharData.stats[id.replace('attr-', '')] = parseInt(el.value) || 10; recalc(); }
        if(id.startsWith('save-prof-')) { activeCharData.saves['prof_'+id.replace('save-prof-', '')] = el.checked; recalc(); }
        if(id === 'hp-curr') activeCharData.stats.hp_curr = parseInt(el.value);
        if(id === 'hp-max') activeCharData.stats.hp_max = parseInt(el.value);
        if(id === 'ac-val') activeCharData.stats.ac = parseInt(el.value);
        if(id === 'speed-mod') { activeCharData.stats.speed_mod = parseInt(el.value); updateSpeed(); }
        if(id.startsWith('money-')) { activeCharData.money[id.replace('money-', '')] = el.value; calcCurrency(); }
        if(id.startsWith('psych-')) activeCharData.psych[id.replace('psych-', '')] = el.value;
        if(id === 'psi-base-attr') { activeCharData.psionics.base_attr = el.value; updatePsi(); }
        if(id === 'psi-caster-type') { activeCharData.psionics.caster_type = el.value; updatePsi(); }
        if(id === 'psi-class-lvl') { activeCharData.psionics.class_lvl = parseInt(el.value); updatePsi(); }
        if(id === 'psi-type-select') activeCharData.psionics.type = el.value;
        if(id === 'psi-mod-input') { activeCharData.psionics.mod_points = parseInt(el.value); updatePsi(); }
        if(id === 'psi-points-curr') activeCharData.psionics.points_curr = parseInt(el.value);
        if(id === 'uni-save-base') { activeCharData.universalis.save_base = parseInt(el.value); calcUniversalSave(); }
        if(id === 'uni-save-attr') { activeCharData.universalis.save_attr = el.value; calcUniversalSave(); }
    }

    function initSkeleton() {
        const attrs = ['str','dex','con','int','wis','cha'];
        document.getElementById('attribute-grid').innerHTML = attrs.map(a => `<div class="stat-box"><h3>${a.toUpperCase()}</h3><input type="number" id="attr-${a}" value="10"><div id="mod-${a}" class="mod-val">+0</div></div>`).join('');
        document.getElementById('saves-table').innerHTML = attrs.map(a => `<tr><td>${a.toUpperCase()}</td><td><input type="checkbox" class="prof-checkbox" id="save-prof-${a}"></td><td><span id="save-val-${a}" class="stat-value">+0</span></td></tr>`).join('');
        const SKILLS = [
            {k:'athletics', n:'Атлетика', a:'str'}, {k:'acrobatics', n:'Акробатика', a:'dex'}, {k:'sleight', n:'Ловкость рук', a:'dex'}, {k:'stealth', n:'Скрытность', a:'dex'},
            {k:'history', n:'История', a:'int'}, {k:'investigation', n:'Расследование', a:'int'}, {k:'tech', n:'Техника', a:'int'}, {k:'programming', n:'Программирование', a:'int'},
            {k:'fund_science', n:'Фун. Физика', a:'int'}, {k:'weapons', n:'Оружие', a:'int'}, {k:'nature', n:'Природа', a:'int'}, {k:'religion', n:'Религия', a:'int'},
            {k:'perception', n:'Восприятие', a:'wis'}, {k:'survival', n:'Выживание', a:'wis'}, {k:'medicine', n:'Медицина', a:'wis'}, {k:'insight', n:'Проницательность', a:'wis'},
            {k:'performance', n:'Выступление', a:'cha'}, {k:'intimidation', n:'Запугивание', a:'cha'}, {k:'deception', n:'Обман', a:'cha'}, {k:'persuasion', n:'Убеждение', a:'cha'}
        ];
        document.getElementById('skills-body').innerHTML = SKILLS.map(s => `<tr data-key="${s.k}" data-attr="${s.a}"><td>${s.n}</td><td>${s.a.toUpperCase()}</td><td><input type="checkbox" class="chk-prof"></td><td><input type="checkbox" class="chk-exp"></td><td><input type="number" class="skill-bonus" value="0"></td><td class="total-mod">+0</td></tr>`).join('');
    }

    function renderAll() {
        const d = activeCharData;
        if(document.activeElement.tagName === "INPUT" || document.activeElement.tagName === "TEXTAREA") { 
            // Avoid re-rendering inputs while typing if possible, or handle cursor
            // For now simple re-render except focused element logic can be complex.
            // Simplified: we will re-render everything EXCEPT values of focused element.
        }

        // Helper to safely set value
        const safeSet = (id, val) => { const el = document.getElementById(id); if (el && document.activeElement !== el) el.value = val; };
        const safeCheck = (id, val) => { const el = document.getElementById(id); if (el) el.checked = val; };

        safeSet('meta-name', d.meta.name); safeSet('meta-race', d.meta.race); safeSet('meta-age', d.meta.age);
        safeSet('meta-rank', d.meta.rank); safeSet('meta-class', d.meta.class); safeSet('meta-archetype', d.meta.archetype);
        safeSet('level-input', d.meta.level); safeSet('meta-job', d.meta.job); safeSet('meta-clearance', d.meta.clearance); safeSet('meta-comm', d.meta.comm);
        if(d.meta.image) document.getElementById('char-img').src = d.meta.image;

        ['str','dex','con','int','wis','cha'].forEach(a => { safeSet(`attr-${a}`, d.stats[a]); safeCheck(`save-prof-${a}`, d.saves['prof_'+a]); });
        safeSet('hp-curr', d.stats.hp_curr); safeSet('hp-max', d.stats.hp_max); safeSet('ac-val', d.stats.ac); safeSet('speed-mod', d.stats.speed_mod);

        document.querySelectorAll('#skills-body tr').forEach(row => {
            const key = row.dataset.key;
            if(d.skills.data[key]) {
                const [p, e, b] = d.skills.data[key];
                if(document.activeElement !== row.querySelector('.chk-prof')) row.querySelector('.chk-prof').checked = p;
                if(document.activeElement !== row.querySelector('.chk-exp')) row.querySelector('.chk-exp').checked = e;
                if(document.activeElement !== row.querySelector('.skill-bonus')) row.querySelector('.skill-bonus').value = b || 0;
            }
            // Bind events if not bound (initSkeleton handles structure, values updated here)
            // But we need to ensure listeners are active. InitSkeleton creates them once.
            // Just update listeners:
            const updateSkill = () => {
                const prof = row.querySelector('.chk-prof').checked;
                const exp = row.querySelector('.chk-exp').checked;
                const bonus = parseInt(row.querySelector('.skill-bonus').value) || 0;
                activeCharData.skills.data[key] = [prof, exp, bonus];
                recalc(); triggerSave();
            };
            row.querySelector('.chk-prof').onchange = updateSkill;
            row.querySelector('.chk-exp').onchange = updateSkill;
            row.querySelector('.skill-bonus').onchange = updateSkill;
        });

        // Lists re-render completely (simple approach)
        renderList('list-weapons', d.combat.weapons, 'weapon');
        renderList('list-inventory', d.combat.inventory, 'item');
        renderList('list-abilities', d.abilities, 'item');
        renderList('list-traits', d.traits, 'table');
        renderList('list-features', d.features, 'table');
        renderList('list-langs', d.profs.langs, 'simple');
        renderList('list-tools', d.profs.tools, 'simple');
        renderList('list-spells', d.psionics.spells, 'spell');
        renderList('list-custom', d.universalis.custom_table, 'weapon');

        const countCont = document.getElementById('list-counters'); countCont.innerHTML = '';
        (d.universalis.counters||[]).forEach((c, idx) => {
            const div = document.createElement('div'); div.className = 'stat-row';
            div.innerHTML = `<span class="stat-label">${c.name}:</span><div style="display:flex;"><input type="number" value="${c.val}" onchange="updateCounter(${idx}, this.value)"><button class="del-btn" onclick="removeCounter(${idx})">[x]</button></div>`;
            countCont.appendChild(div);
        });

        safeSet('money-u', d.money.u); safeSet('money-k', d.money.k); safeSet('money-m', d.money.m); safeSet('money-g', d.money.g);
        safeSet('psych-size', d.psych.size); safeSet('psych-age', d.psych.age); safeSet('psych-height', d.psych.height);
        safeSet('psych-weight', d.psych.weight); safeSet('psych-trait', d.psych.trait); safeSet('psych-ideal', d.psych.ideal);
        safeSet('psych-bond', d.psych.bond); safeSet('psych-flaw', d.psych.flaw); safeSet('psych-analysis', d.psych.analysis);
        
        safeSet('psi-base-attr', d.psionics.base_attr); safeSet('psi-caster-type', d.psionics.caster_type);
        safeSet('psi-class-lvl', d.psionics.class_lvl); safeSet('psi-type-select', d.psionics.type);
        safeSet('psi-mod-input', d.psionics.mod_points); safeSet('psi-points-curr', d.psionics.points_curr);
        
        safeSet('uni-save-base', d.universalis.save_base); safeSet('uni-save-attr', d.universalis.save_attr);

        recalc();
    }

    // LIST LOGIC
    window.addItemToGlobal = (type) => {
        const name = prompt("Название:"); if(!name) return;
        let targetArray; let newItem = { name: name, desc: "", type: prompt("Тип:") || "-" };
        if(type === 'spells') newItem = { name: name, time: "1 действие", range: "18м", conc: false, dur: "Мгновенно", cost: 0, desc: "" };
        
        if(type === 'weapons') targetArray = activeCharData.combat.weapons;
        else if(type === 'inventory') targetArray = activeCharData.combat.inventory;
        else if(type === 'abilities') targetArray = activeCharData.abilities;
        else if(type === 'traits') targetArray = activeCharData.traits;
        else if(type === 'features') targetArray = activeCharData.features;
        else if(type === 'spells') targetArray = activeCharData.psionics.spells;
        else if(type === 'custom') targetArray = activeCharData.universalis.custom_table;
        
        targetArray.push(newItem); triggerSave();
    };

    window.addSimpleItem = (type) => { const name = prompt("Название:"); if(name) { activeCharData.profs[type].push(name); triggerSave(); } };

    function renderList(containerId, array, mode) {
        const el = document.getElementById(containerId); el.innerHTML = '';
        (array||[]).forEach((item, idx) => {
            let div = document.createElement(mode.includes('table')||mode==='spell' ? 'tr' : 'div');
            if(mode === 'weapon' || mode === 'item') {
                div.className = mode === 'weapon' ? 'weapon-row' : 'stat-row interactive-list-item';
                div.onclick = () => openModal(item);
                div.innerHTML = `<span class="stat-label">${item.type || ''}</span> <span class="stat-value">${item.name}</span> <button class="del-btn" onclick="deleteItem(event, '${containerId}', ${idx})">[x]</button>`;
            } else if(mode === 'simple') {
                div.innerHTML = `<span>${item}</span> <button class="del-btn" onclick="deleteItem(event, '${containerId}', ${idx})">[x]</button>`;
            } else if(mode === 'table') {
                div.innerHTML = `<td>${item.name}</td><td>${item.type}</td><td><button class="del-btn" onclick="deleteItem(event, '${containerId}', ${idx})">[x]</button></td>`;
            } else if(mode === 'spell') {
                div.innerHTML = `<td><button class='spell-name-btn'>${item.name}</button></td><td><input type='text' value='${item.time}' onchange='updateSpell(${idx}, "time", this.value)'></td><td><input type='text' value='${item.range}' onchange='updateSpell(${idx}, "range", this.value)'></td><td><input type='checkbox' ${item.conc ? 'checked' : ''} onchange='updateSpell(${idx}, "conc", this.checked)'></td><td><input type='text' value='${item.dur}' onchange='updateSpell(${idx}, "dur", this.value)'></td><td><input type='number' value='${item.cost}' onchange='updateSpell(${idx}, "cost", this.value)'></td><td><button class='del-btn' onclick="deleteItem(event, '${containerId}', ${idx})">[x]</button></td>`;
                div.querySelector('.spell-name-btn').onclick = () => openModal(item);
            }
            el.appendChild(div);
        });
    }

    window.deleteItem = (e, containerId, idx) => {
        e.stopPropagation();
        if(containerId === 'list-weapons') activeCharData.combat.weapons.splice(idx, 1);
        else if(containerId === 'list-inventory') activeCharData.combat.inventory.splice(idx, 1);
        else if(containerId === 'list-abilities') activeCharData.abilities.splice(idx, 1);
        else if(containerId === 'list-traits') activeCharData.traits.splice(idx, 1);
        else if(containerId === 'list-features') activeCharData.features.splice(idx, 1);
        else if(containerId === 'list-langs') activeCharData.profs.langs.splice(idx, 1);
        else if(containerId === 'list-tools') activeCharData.profs.tools.splice(idx, 1);
        else if(containerId === 'list-spells') activeCharData.psionics.spells.splice(idx, 1);
        else if(containerId === 'list-custom') activeCharData.universalis.custom_table.splice(idx, 1);
        triggerSave();
    };

    window.updateSpell = (idx, field, value) => { activeCharData.psionics.spells[idx][field] = value; triggerSave(); };
    window.addCounter = () => { const name = prompt("Название:"); if(name) { activeCharData.universalis.counters.push({name:name, val:0}); triggerSave(); } };
    window.updateCounter = (idx, val) => { activeCharData.universalis.counters[idx].val = parseInt(val); triggerSave(); };
    window.removeCounter = (idx) => { activeCharData.universalis.counters.splice(idx, 1); triggerSave(); };

    window.openModal = (item) => {
        activeModalItem = item;
        document.getElementById('weapon-modal').style.display = 'flex';
        document.getElementById('modal-title-input').value = item.name;
        document.getElementById('modal-desc').value = item.desc || "";
        document.getElementById('modal-title-input').oninput = (e) => { activeModalItem.name = e.target.value; };
        document.getElementById('modal-desc').oninput = (e) => { activeModalItem.desc = e.target.value; };
    };
    window.closeWeaponModal = () => { document.getElementById('weapon-modal').style.display = 'none'; activeModalItem = null; triggerSave(); };

    function recalc() {
        if(!activeCharData) return;
        const d = activeCharData; const lvl = d.meta.level || 1; const pb = 2 + Math.floor((lvl - 1) / 4);
        document.getElementById('pb-display').innerText = "+" + pb;
        const mods = {};
        ['str','dex','con','int','wis','cha'].forEach(a => {
            const val = d.stats[a] || 10; const mod = Math.floor((val - 10) / 2); mods[a] = mod;
            document.getElementById(`mod-${a}`).innerText = (mod >= 0 ? "+" : "") + mod;
            const save = mod + (d.saves['prof_'+a] ? pb : 0);
            document.getElementById(`save-val-${a}`).innerText = (save >= 0 ? "+" : "") + save;
        });
        document.querySelectorAll('#skills-body tr').forEach(row => {
            const attr = row.dataset.attr; const key = row.dataset.key;
            const [p, e, b] = d.skills.data[key] || [false,false,0];
            let total = mods[attr] + b; if(e) total += (pb*2); else if(p) total += pb;
            row.querySelector('.total-mod').innerText = (total >= 0 ? "+" : "") + total;
        });
        updatePsi(); calcUniversalSave(); updateSpeed(); calcCurrency();
    }

    function updatePsi() {
        const d = activeCharData; if(!d) return;
        const baseMod = Math.floor(((d.stats[d.psionics.base_attr]||10) - 10)/2);
        const pb = 2 + Math.floor(((d.meta.level||1) - 1) / 4);
        document.getElementById('psi-dc-display').innerText = 8 + pb + baseMod + Math.max(0, (d.psionics.class_lvl||1) - 2);
        const pts = (parseFloat(d.psionics.caster_type) === 1 ? 6 : (parseFloat(d.psionics.caster_type) === 0.5 ? 3 : 2)) + (d.psionics.mod_points||0);
        document.getElementById('psi-points-max').innerText = pts * (d.meta.level||1);
    }
    function calcUniversalSave() {
        const d = activeCharData; if(!d) return;
        const mod = Math.floor(((d.stats[d.universalis.save_attr]||10) - 10)/2);
        const pb = 2 + Math.floor(((d.meta.level||1) - 1) / 4);
        document.getElementById('uni-save-result').innerText = (d.universalis.save_base||10) + mod + pb;
    }
    function updateSpeed() {
        const d = activeCharData; if(!d) return;
        document.getElementById('speed-display').innerText = (9 + ((d.stats.speed_mod||0) * 1.5)) + " м";
    }
    function calcCurrency() {
        const d = activeCharData; if(!d) return;
        const total = ((parseFloat(d.money.g)||0) * 1000000) + ((parseFloat(d.money.m)||0) * 1000) + (parseFloat(d.money.k)||0) + ((parseFloat(d.money.u)||0) / 1000);
        document.getElementById('total-kg').innerText = total.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + " kG";
    }

    window.triggerImageUpload = () => {
        const c = prompt("1. URL\n2. Файл");
        if(c==="1") { const u = prompt("URL:"); if(u) { activeCharData.meta.image = u; triggerSave(); document.getElementById('char-img').src=u; } }
        else if(c==="2") document.getElementById('img-upload').click();
    };
    window.handleImageUpload = (inp) => {
        if(inp.files[0]) { const r = new FileReader(); r.onload = (e) => { activeCharData.meta.image = e.target.result; document.getElementById('char-img').src = e.target.result; triggerSave(); }; r.readAsDataURL(inp.files[0]); }
    };

    window.showPanel = (id) => {
        document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('access-denied').style.display = 'none';
        if(lockStates[id]) document.getElementById('access-denied').style.display = 'flex';
        else document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    };
    window.showSubPanel = (id) => {
        document.querySelectorAll('.sub-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.sub-nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    };
    window.toggleLock = (id, cb) => {
        lockStates[id] = cb.checked;
        if(document.querySelector('.nav-btn.active').getAttribute('onclick').includes(id)) window.showPanel(id);
    };
</script>
</body>
</html>
